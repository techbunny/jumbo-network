#cloud-config

 

#yum_repos:
#  # Not needed it seems, leaving it anyway in case..
#  epel-testing:
#    baseurl: http://download.fedoraproject.org/pub/epel/testing/5/$basearch
#    metalink: https://mirrors.fedoraproject.org/metalink?repo=testing-epel7&arch=$basearch&infra=$infra&content=$contentdir
#    enabled: false
#    failovermethod: priority
#    gpgcheck: true
#    gpgkey: file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7
#    name: Extra Packages for Enterprise Linux 7 - Testing

 

package_upgrade: false
packages:
  - unzip
  - screen
  - iperf3
  
ssh_authorized_keys:
 # - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDPBZ+1Bpbldb4coFctsgLxafpyLhmOcabZOfXYOMPi/Nak7y5FWxCJJEoHwpjAQkc31dVnlc4+6D9ZkRW4CCPOSXBL1+vBRb07zTd91bKMpgyXWmtX/ZDHSYNliFscWj0LUXmUA10govZowy4nM51LoYWRee1U5KW4+vZvthUyQYtfIveR4M2uw/MGafE5Qy6FyF6RGupQ1W8oY1laEcknVACJRoY2xxuI4gR4NjaaeZTyIHd/rA/EftahqvOCwbo49T0+dquFOL1y54BI0XY/btjyudKY8nZ5U4SoFR9uKf2Dsx8tZetfZbT/+YGtCqaaaIlh2CmpW0GgyBvGRSG5
 # - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDVfZBRGWEiHVkFirE73qQKeCTYcK/ydIRlKYg5vrBksIFnl6DcYif+KCxv89gJ9nhTKZr3bfD0OlRYEtzB+cSCYC2TqfevJF3SHjgDHIx6tk/2xA5GcGiEFV0dKEhGSGtat4ycKWuRFgj+uIWBkFa+HWbrrM1YmlcPOskIv52o0A5wWhxuDxNsp1vUHrMatNVshkCUukF83g2Ki1KAzOnIarlZ1Px0IqpDXODlDTOBm3vmyi3EY79Gg6fkEVHDIdk+46a0v7MIyf7cFYHjVDKjKFrNVzyG9O/g+xWfbMWS95QCZ3QBjeOz6cbT+jO4TBtbKMbSCDOHVHIfH2LZQG1f
 # - ssh-rsa AAAAB3NzaC1yc2EAAAABJQAAAQEA3AOUimtAGkk5IQkr1OmpvAU4YmnT6GV9UEFlQdT9osWSqtBMAUzNInPniZwMbUZwXC7nWIdqSOhxo8iSQDOdoe0UmVnBUH0DS7V+y7vf8w1tEwHq/XB2z3AWcbK5D4vH011Lz9HwTMEebt4ADehISNuituuYjyDD34uwxCm4poJd2g8pNCGDCyUCHOAekPdHpStN6+o6SvcaV8pdivziIkNRzhwX3Nk8geCoESVQaz+WnTxGPcPO+tWf4QvyqHHSNjeY/Ii6eMk2dhBxq0Fn5lde5B63eAp3VgVJBgVLbkKwxl73E0Xt19kMGh0vp8zQ3tTyIMhV78zxGT1jTCx6Aw==
 

write_files:
  - owner: root:root
    path: /etc/systemd/system/edgeclient.service
    content: |
      [Unit]
      Description=VMBlaster waiting for commands to spread some blasting love
      
      [Service]
      # systemd will run this executable to start the service
      ExecStart=/opt/vmblaster/edgeclient
      # to query logs using journalctl, set a logical name here
      SyslogIdentifier=edgeclient
      User=root
           
      Environment=DPS_ENROLLMENT_KEY=XmuQJFmLSWBmBofUFLAKQ/WNVKu+E0YqoLnbYRDHbVkSckMppf1g82milRGM801UTJTwM9AO9BJs96ixSKKVTg==
      Environment=DPS_ID_SCOPE=0ne001EB486
      Environment=DPS_ENROLLMENT_GROUP=e-edgevms
      Environment=DPS_GLOBAL_DEVICE_ENDPOINT=global.azure-devices-provisioning.net
      Environment=LOG_FOLDER=/opt/vmblaster/logs
      [Install]
      WantedBy=multi-user.target
   
runcmd:
#  - register the VM with the function - do this outside of the VMBlaster/client?
  - mkdir -p -m 755 /opt/vmblaster/logs
  - [ wget, "https://ronieuwe.blob.core.windows.net/blaster/EdgeClient?sv=2019-10-10&st=2020-12-28T21%3A54%3A00Z&se=2030-12-30T21%3A54%3A00Z&sr=b&sp=r&sig=90I3Yki7iAoUAelYF2H3AKkkyNGpv128Gq8RxTIemvc%3D", -O, /opt/vmblaster/edgeclient ]
  - chown -R sysadmin /opt/vmblaster/
  - chmod -R 755 /opt/vmblaster/
  - systemctl daemon-reload
  - systemctl start edgeclient

 

final_message: "The system is finally up, after $UPTIME seconds"